<!DOCTYPE html>
<html lang="pt-br">
<head>
    {% extends "base.html" %}
    {% block title %}Gerenciamento de Armazenamento{% endblock %}
</head>

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Gerenciamento de Armazenamento</h2>

    <!-- Tabela de Diretórios -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Diretórios de Armazenamento</h5>
        </div>
        <div class="card-body">
            {% if storage_stats %}
            <div class="row mb-3">
                <div class="col-md-4 mb-2 mb-md-0">
                    <div class="border rounded p-3 h-100">
                        <div class="text-muted small">Total Armazenado | Espaço Geral</div>
                        <div class="h5 mb-0">{{ "%.2f"|format(storage_stats.total_gb|float) }} GB{% if overall_total_gb is defined %} / {{ "%.2f"|format(overall_total_gb|float) }} GB{% endif %}</div>
                        {% if overall_total_gb is defined and overall_total_gb|float > 0 %}
                        {% set total_gb = storage_stats.total_gb|float %}
                        {% set capacity_gb = overall_total_gb|float %}
                        {% set percent = (total_gb / capacity_gb * 100) %}
                        {% set clamped = percent if percent < 100 else 100 %}
                        {% set bar_class = 'bg-success' %}
                        {% if percent >= 85 %}
                            {% set bar_class = 'bg-danger' %}
                        {% elif percent >= 60 %}
                            {% set bar_class = 'bg-warning' %}
                        {% endif %}
                        <div class="progress mt-2" style="height: 10px;">
                            <div class="progress-bar {{ bar_class }}" role="progressbar" style="width: {{ clamped|round(1) }}%;" aria-valuenow="{{ percent|round(1) }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="small text-muted mt-1">{{ percent|round(1) }}% utilizado</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 mb-2 mb-md-0">
                    <div class="border rounded p-3 h-100">
                        <div class="text-muted small">Média diária (últimos 30 dias)</div>
                        <div class="h5 mb-0">{{ storage_stats.avg_mb_per_day_30 }} MB/dia</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <div class="text-muted small">Dias restantes (estimativa)</div>
                        <div class="h5 mb-0">{{ storage_stats.days_remaining if storage_stats.days_remaining is not none else 'N/A' }}</div>
                        {% if storage_stats.free_mb %}
                        <div class="text-muted small">Livre: {{ storage_stats.free_mb }} MB</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th style="width: 3%">ID</th>
                            <th style="width: 20%">Diretório</th>
                            <th style="width: 10%">Grupo</th>
                            <th style="width: 10%">AET</th>
                            <th style="width: 10%">Status</th>
                            <th style="width: 10%">Total</th>
                            <th style="width: 10%">Usado</th>
                            <th style="width: 10%">Armazenamento</th>
                            <th style="width: 15%">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dir in directories %}
                        <tr>
                            <td>{{ dir.pk }}</td>
                            <td>{{ dir.dirpath }}</td>
                            <td>{{ dir.fs_group_id }}</td>
                            <td>{{ dir.retrieve_aet }}</td>
                            <td>
                                {% if dir.fs_status == 0 %}
                                <span class="badge bg-success">Principal</span>
                                {% else %}
                                <span class="badge bg-secondary">Secundário</span>
                                {% endif %}
                            </td>
                            <td>{{ "%.2f"|format(dir.total|float / 1024**3) }} GB</td>
                            <td>{{ "%.2f"|format(dir.used|float / 1024**3) }} GB</td>
                            <td>{{ dir.qtd }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-success" onclick="alterarOrdem('{{ dir.pk }}', 'subir')" title="Subir prioridade"><i class="fas fa-arrow-up"></i></button>
                                    <button class="btn btn-sm btn-warning" onclick="alterarOrdem('{{ dir.pk }}', 'descer')" title="Descer prioridade"><i class="fas fa-arrow-down"></i></button>
                                    <button class="btn btn-sm btn-primary" onclick="editarDiretorio('{{ dir.pk }}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirDiretorio('{{ dir.pk }}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Botão para adicionar novo diretório -->
    <div class="mt-3">
        <button class="btn btn-success" onclick="limparEAbrirModal()">
            <i class="fas fa-plus me-2"></i>Adicionar Diretório
        </button>
    </div>

    <!-- Modal para adicionar/editar diretório -->
    <div class="modal fade" id="modalDiretorio" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Adicionar Diretório</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formDiretorio">
                        <div class="mb-3">
                            <label for="dirpath" class="form-label">Caminho do Diretório</label>
                            <input type="text" class="form-control" id="dirpath" name="dirpath" required>
                        </div>
                        <div class="mb-3">
                            <label for="fs_group_id" class="form-label">Grupo</label>
                            <input type="text" class="form-control" id="fs_group_id" name="fs_group_id" required>
                        </div>
                        <div class="mb-3">
                            <label for="retrieve_aet" class="form-label">AET</label>
                            <input type="text" class="form-control" id="retrieve_aet" name="retrieve_aet" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="fs_status" name="fs_status">
                                <label class="form-check-label" for="fs_status">Definir como Diretório Principal</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarDiretorio()">Salvar</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function limparEAbrirModal() {
    document.getElementById('modalTitle').textContent = 'Adicionar Diretório';
    document.getElementById('formDiretorio').reset();
    new bootstrap.Modal(document.getElementById('modalDiretorio')).show();
}

function editarDiretorio(pk) {
    document.getElementById('modalTitle').textContent = 'Editar Diretório';
    
    // Buscar dados do diretório
    fetch(`/configuracoes/armazenamento/buscar/${encodeURIComponent(pk)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Erro ao carregar dados do diretório: ' + data.error);
                return;
            }
            // Preencher formulário com os dados
            document.getElementById('dirpath').value = data.dirpath;
            document.getElementById('fs_group_id').value = data.fs_group_id;
            document.getElementById('retrieve_aet').value = data.retrieve_aet;
            document.getElementById('fs_status').checked = data.fs_status === 0;
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados do diretório');
        });

    // Abrir modal
    new bootstrap.Modal(document.getElementById('modalDiretorio')).show();
}

function excluirDiretorio(pk) {
    if (confirm('Tem certeza que deseja excluir este diretório?')) {
        // Implementar lógica de exclusão
        fetch(`/configuracoes/armazenamento/excluir/${encodeURIComponent(pk)}`, {
            method: 'DELETE'
        })
        .then(response => {
            // Verifica se a resposta é um redirecionamento (HTML) em vez de JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                // Se retornou HTML, significa que foi redirecionado (usuário sem permissão)
                alert('Acesso negado. Apenas administradores podem realizar esta ação.');
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                location.reload();
            } else if (data) {
                alert('Erro ao excluir diretório: ' + data.message);
            }
        });
    }
}

function salvarDiretorio() {
    const formData = new FormData(document.getElementById('formDiretorio'));
    const data = Object.fromEntries(formData.entries());
    data.fs_status = document.getElementById('fs_status').checked ? 0 : 1;

    fetch('/configuracoes/armazenamento/salvar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // Verifica se a resposta é um redirecionamento (HTML) em vez de JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            // Se retornou HTML, significa que foi redirecionado (usuário sem permissão)
            alert('Acesso negado. Apenas administradores podem realizar esta ação.');
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            location.reload();
        } else if (data) {
            alert('Erro ao salvar diretório: ' + data.message);
        }
    });
}

function alterarOrdem(pk, acao) {
    fetch(`/configuracoes/armazenamento/alterar-ordem/${encodeURIComponent(pk)}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ acao: acao })
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            alert('Acesso negado. Apenas administradores podem realizar esta ação.');
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            location.reload();
        } else if (data) {
            alert('Erro ao alterar ordem: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao alterar ordem do diretório');
    });
}
</script>
{% endblock %}
{% endblock %}
</html>